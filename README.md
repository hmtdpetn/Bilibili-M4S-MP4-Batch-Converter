# B站缓存M4S批量转换MP4工具 (Bilibili M4S Batch Converter)

## 概述

本项目是一个使用Python和Tkinter编写的图形化工具，旨在帮助用户将从哔哩哔哩（Bilibili）官方客户端下载的视频缓存文件（通常为M4S格式）批量转换为通用的MP4格式。它能够智能识别电脑端和手机端下载的不同缓存结构，并对特定类型的M4S文件进行必要的预处理，以便FFmpeg能够成功进行无损转换。

我们发现，B站电脑端下载的M4S文件头部与标准MP4流格式存在差异，需要进行特定的字节修复才能被FFmpeg正确解析。而手机端下载的M4S文件通常可以直接合并。本工具内置了这些处理逻辑。

## 主要功能

* **图形用户界面 (GUI)**：提供简单易用的操作界面。
* **智能识别缓存结构**：
    * 自动检测并支持**电脑端**（通常包含 `videoInfo.json` 和数字ID命名的M4S文件）的缓存结构。
    * 自动检测并支持**手机端**（通常包含 `c_xxxx` 子文件夹、`entry.json` 和 `video.m4s`/`audio.m4s` 或带码率的M4S文件）的缓存结构。
* **M4S头部修复**：
    * 对于识别为电脑端下载的M4S文件，会自动进行头部字节修复，解决FFmpeg无法直接处理的问题。
    * 对于手机端下载的M4S文件，会首先尝试直接合并；如果失败，则会尝试应用电脑端的修复逻辑。
* **批量处理**：
    * 支持通过“添加文件夹”按钮逐个添加B站视频缓存的顶层文件夹。
    * 支持通过“批量添加”按钮，选择一个父文件夹，工具会自动扫描并列出其中所有符合B站缓存结构的子文件夹，供用户勾选添加。
* **自定义输出**：允许用户指定转换后MP4文件的保存位置。
* **自动命名**：根据缓存文件夹中的元数据文件（`videoInfo.json` 或 `entry.json`）提取视频标题，并用于命名输出的MP4文件。
* **无损转换**：使用FFmpeg的 `-c copy` 参数，直接复制音视频流，确保转换过程无编码质量损失。
* **进度显示与日志**：提供处理进度条和详细的操作日志。

## 技术细节：M4S文件处理差异

通过分析和实验，我们发现不同客户端下载的B站M4S缓存文件在处理上有所不同：

* **电脑端缓存 (PC Downloads)**：
    * 这类缓存的M4S文件（通常与 `videoInfo.json` 在同一层级，文件名类似 `xxxx-1-30080.m4s`）其文件头部并非标准的MP4流格式。直接使用FFmpeg处理会导致“Invalid data found when processing input”错误。
    * **解决方案**：本工具内置了一个M4S“解码”/修复函数。该函数会读取M4S文件的第一个数据块（约1KB），进行特定的字节操作：
        1.  移除文件最开始的9个自定义字节。
        2.  修改修复后特定位置的字节值（新索引第3字节改为`0x20`）。
        3.  根据是否存在标准的"iso5" MP4品牌标记，条件性地移除另外4个字节。
    * 经过这个预处理后，M4S文件的头部才符合FFmpeg的解析要求。

* **手机端缓存 (Mobile Downloads)**：
    * 这类缓存通常在 `c_xxxx` 文件夹下的数字ID文件夹中，包含 `entry.json` 以及 `video.m4s` 和 `audio.m4s` (或类似带码率ID的M4S文件)。
    * 这些M4S文件头部通常是标准的，可以直接被FFmpeg识别和合并。
    * **处理策略**：本工具会首先尝试直接合并手机端的M4S文件。如果直接合并失败（例如，某些特殊情况下手机端也可能采用了类似电脑端的头部处理），工具会自动回退，尝试对这些M4S文件也应用上述的头部修复逻辑，然后再进行合并。

## 使用前准备

### 1. Python环境

确保你的电脑上安装了Python 3.x (推荐 Python 3.7 或更高版本)。可以从 [Python官网](https://www.python.org/downloads/) 下载并安装。

### 2. FFmpeg

本工具依赖 FFmpeg 来进行实际的音视频合并操作。

* **下载FFmpeg**：
    * 对于Windows用户，推荐从 [Gyan.dev](https://www.gyan.dev/ffmpeg/builds/) 下载FFmpeg的完整版本 (full build)。下载解压后会得到一个包含 `bin`, `doc`, `presets` 等文件夹的目录。
    * 对于其他操作系统用户，可以从 [FFmpeg官网下载页面](https://ffmpeg.org/download.html) 找到适合你系统的版本。

* **配置FFmpeg路径**：
    为了让本Python脚本能够找到并使用FFmpeg，你需要按照以下结构组织文件：
    1.  创建一个主项目文件夹，例如 `Bilibili_Converter`。
    2.  将下载的Python脚本（例如 `bilibili.py`）放到这个 `Bilibili_Converter` 文件夹中。
    3.  在 `Bilibili_Converter` 文件夹内，创建一个名为 `ffmpeg` 的子文件夹。
    4.  在 `ffmpeg` 子文件夹内，再创建一个名为 `bin` 的子文件夹。
    5.  将你下载并解压的FFmpeg包中的 `bin` 目录下的**所有文件**（包括 `ffmpeg.exe`, `ffprobe.exe`, `ffplay.exe` 以及所有的 `.dll` 文件）复制到你刚刚创建的 `Bilibili_Converter/ffmpeg/bin/` 目录中。

    最终的文件结构应如下所示：
    ```
    Bilibili_Converter/
    ├── bilibili.py              (你的Python脚本)
    └── ffmpeg/
        └── bin/
            ├── ffmpeg.exe
            ├── ffprobe.exe
            ├── ffplay.exe
            └── ... (所有相关的 .dll 文件)
    ```
    脚本会自动按照这个结构去查找 `ffmpeg.exe`。

### 3. Python依赖库

本脚本主要使用Python内置的 `tkinter` 库构建GUI，核心功能不需要额外安装第三方pip包。

（如果你在Windows上希望“添加文件夹”按钮也能支持原生多选，可以安装 `pywin32` (`pip install pywin32`)，脚本v7版本曾包含此逻辑，但当前版本主要依赖自定义的“批量添加”对话框实现多选，因此 `pywin32` 不是运行核心功能的强制依赖。）

## 如何运行脚本

1.  确保已完成上述“使用前准备”中的Python环境配置和FFmpeg路径配置。
2.  打开命令提示符（cmd）或终端（Terminal）。
3.  使用 `cd` 命令导航到你的主项目文件夹（例如 `cd path/to/Bilibili_Converter`）。
4.  运行以下命令启动脚本：
    ```bash
    python bilibili.py
    ```
5.  脚本启动后，会显示图形用户界面。

## 使用说明

1.  **添加源文件夹**：
    * **添加文件夹**：点击此按钮，会弹出标准的文件夹选择对话框，用于选择单个B站视频缓存的顶层文件夹（例如，名为一串数字的文件夹，如 `311393898`，或者包含 `c_xxxx` 子文件夹的目录）。脚本会自动检测其结构。
    * **批量添加**：点击此按钮，会弹出一个自定义的批量选择对话框。
        * 首先，点击“选择父文件夹”，选择一个包含多个B站视频缓存顶层文件夹的总目录。
        * 脚本会自动扫描该父目录下的子文件夹，并列出所有识别为有效B站缓存结构（电脑端或手机端）的文件夹，同时显示其类型和提取到的标题。
        * 勾选你想要处理的文件夹。
        * 点击“确定”将选中的文件夹添加到主界面的处理列表中。
2.  **管理列表**：
    * **移除选中**：在主界面的文件夹列表中，选中一个或多个（按住Ctrl或Shift）已添加的文件夹条目，然后点击此按钮进行移除。
    * **清空列表**：点击此按钮，会清空处理列表中的所有文件夹。
3.  **选择输出文件夹**：点击“选择输出文件夹”按钮，指定一个用于保存转换后MP4视频的目录。
4.  **开始处理**：设置好源文件夹和输出路径后，点击“开始处理”按钮。脚本会依次处理列表中的每个文件夹。
5.  **查看日志和进度**：处理过程中，可以在界面下方的日志区域查看详细的操作信息、成功与失败的记录以及FFmpeg的输出。进度条会显示总体处理进度。

## 重要注意事项

* **针对B站缓存**：本工具是为处理哔哩哔哩官方客户端下载的视频缓存而设计的。不保证适用于其他来源的M4S文件。
* **文件结构依赖**：工具依赖特定的文件和文件夹结构来识别视频信息（如 `videoInfo.json`, `entry.json`, `c_xxxx` 文件夹等）。如果B站更新了其缓存结构，本工具可能需要相应调整。
* **M4S头部修复**：如前所述，电脑端M4S文件的头部修复是基于对特定格式的观察。如果B站修改了其头部处理方式，解码逻辑可能也需要更新。
* **FFmpeg版本**：建议使用较新版本的FFmpeg以获得最佳兼容性。
* **无损转换**：转换过程使用 `-c copy`，仅改变容器格式，不重新编码音视频流，因此是无损的。最终MP4文件的质量取决于原始缓存文件的质量。
* **错误处理**：脚本包含了一些基本的错误处理。如果遇到问题，请首先查看日志区域的详细信息。常见的FFmpeg错误 "Invalid data found when processing input" 通常与M4S文件头部问题或文件损坏有关（本工具已尝试通过解码修复前者）。

---
